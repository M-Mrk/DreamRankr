{% extends "base.html" %}

{% block content %}
<h1>Trainer Management</h1>

<!-- Challenge Modal -->
<div class="modal fade" id="challengeWindow" tabindex="-1" aria-labelledby="challengeWindowLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Start Challenge</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="challengeWindowInputLabel" for="input-datalist">Who does the player challenge?</label>
                    <form method="post" action="/trainer/start_match">
                        <input type="text" 
                            class="form-control" 
                            placeholder="Choose a player..." 
                            list="list-timezone" 
                            id="input-datalist"
                            autocomplete="off"
                            required>
                        <input type="hidden" id="challenger-id" name="challenger_id">
                        <input type="hidden" id="defender-id" name="defender_id">
                        <datalist id="list-timezone">
                            <!-- Options will be populated dynamically -->
                        </datalist>
                        <div class="invalid-feedback">
                            Please select a valid player from the list.
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Start</button>
            </div>
        </div>
    </div>
</div>

<!-- Finish Match Modal -->
<div class="modal fade" id="finishMatchModal" tabindex="-1" aria-labelledby="finishMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finishMatchModalLabel">Finish Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="finishMatchModalContent">
                <p>Modal content placeholder</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startSpinner('finishMatchModalContent')">Finish Match</button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Container -->
<div class="container-fluid">
    <div class="row">
        <!-- Table Section -->
        <div class="col-12 col-lg-8 mb-4">
            <div class="table-responsive" style="max-height: 70vh;">
                <table class="table table-striped table-hover" id="playerTable">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th>Ranking</th>
                            <th>Player</th>
                            <th>Wins</th>
                            <th>Losses</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in players %}
                        <tr class="player-row" data-player-id="{{ player.ranking }}" data-player-name="{{ player.name }}">
                            <td><strong>{{ player.ranking }}</strong></td>
                            <td>{{ player.name }}</td>
                            <td>{{ player.wins }}</td>
                            <td>{{ player.losses }}</td>
                        </tr>
                        <tr class="expand-row" id="expand-{{ player.ranking }}" style="display:none;">
                            <td colspan="4">
                                <div class="d-flex gap-2 justify-content-center flex-wrap">
                                    <button type="button" class="btn btn-primary btn-sm challenge-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#challengeWindow"
                                            data-player-id="{{ player.id }}"
                                            data-player-name="{{ player.name }}">
                                        Challenge
                                    </button>
                                    <button class="btn btn-warning btn-sm">Timeout</button>
                                    <button class="btn btn-secondary btn-sm edit-btn" data-player-name="{{ player.name }}">Edit</button>
                                    <button class="btn btn-danger btn-sm">Delete</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Side Section -->
        <div class="col-12 col-lg-4">
            <!-- Active Challenges Section -->
            <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                    <h4 class="mb-0 me-2">Active Challenges</h4>
                    <hr class="flex-grow-1">
                </div>
                <div class="activeMatches">
                    {% if activeMatches %}
                        <div id="activeMatchesCarousel" class="carousel slide">
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                    <div class="bg-light p-3 rounded text-center">
                                        <div class="row align-items-center">
                                            <div class="col">
                                                <h5>{{ activeMatches[0].challenger }}</h5>
                                            </div>
                                            <div class="col-auto">
                                                <span class="badge bg-primary">vs</span>
                                            </div>
                                            <div class="col">
                                                <h5>{{ activeMatches[0].defender }}</h5>
                                            </div>
                                        </div>
                                        <p class="text-muted mb-2">Since: {{ activeMatches[0].timeStarted.strftime('%H:%M') }}</p>
                                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#finishMatchModal">
                                            Finish Match
                                        </button>
                                    </div>
                                </div>
                                {% for match in activeMatches[1:] %}
                                    <div class="carousel-item">
                                        <div class="bg-light p-3 rounded text-center">
                                            <div class="row align-items-center">
                                                <div class="col">
                                                    <h5>{{ match.challenger }}</h5>
                                                </div>
                                                <div class="col-auto">
                                                    <span class="badge bg-primary">vs</span>
                                                </div>
                                                <div class="col">
                                                    <h5>{{ match.defender }}</h5>
                                                </div>
                                            </div>
                                            <p class="text-muted mb-2">Since: {{ match.timeStarted.strftime('%H:%M') }}</p>
                                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#finishMatchModal">
                                                Finish Match
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if activeMatches|length > 1 %}
                                <button class="carousel-control-prev" type="button" data-bs-target="#activeMatchesCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#activeMatchesCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="bg-light p-3 rounded text-center text-muted">
                            <p class="mb-0">There are currently no active challenges.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Add Player Section -->
            <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                    <h4 class="mb-0 me-2">Add Player</h4>
                    <hr class="flex-grow-1">
                </div>
                <form method="post" action="/trainer/player_add">
                    <div class="input-group">
                        <input type="text" class="form-control" id="name" name="name" placeholder="Player Name" required>
                        <button type="submit" class="btn btn-dark">Add Player</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}