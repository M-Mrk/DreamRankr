{% extends "base.html" %}

{% block content %}
<h1>{{ ranking.name }}</h1>

<!-- Challenge Modal -->
<div class="modal fade" id="challengeWindow" tabindex="-1" aria-labelledby="challengeWindowLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Start Challenge</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="challengeWindowInputLabel" for="input-datalist">Who does the player challenge?</label>
                    <form method="post" action="/trainer/start_match">
                        <input type="text" 
                            class="form-control" 
                            placeholder="Choose a player..." 
                            list="list-defender" 
                            id="input-datalist"
                            autocomplete="off"
                            required>
                        <input type="hidden" id="challenger-id" name="challenger_id">
                        <input type="hidden" id="defender-id" name="defender_id">
                        <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
                        <datalist id="list-defender">
                            <!-- Options will be populated dynamically -->
                        </datalist>
                        <div class="invalid-feedback">
                            Please select a valid player from the list.
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Start</button>
            </div>
        </div>
    </div>
</div>

<!-- Finish Match Modal -->
<div class="modal fade" id="finishMatchModal" tabindex="-1" aria-labelledby="finishMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finishMatchModalLabel">Finish Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="finishMatchModalContent">
                <form method="post" action="/trainer/finish_match">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="inputChallengerSetsWon" class="form-label">Challenger Name</label>
                            <input type="number" class="form-control" placeholder="Challenger sets won" aria-label="Challenger sets won" id="inputChallengerSetsWon" name="challenger_score">
                        </div>
                        <div class="col-md-6">
                            <label for="inputDefenderSetsWon" class="form-label">Defender Name</label>
                            <input type="number" class="form-control" placeholder="Defender sets won" aria-label="Defender sets won" id="inputDefenderSetsWon" name="defender_score">
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="challengerWonCheckbox">
                                <label class="form-check-label" for="challengerWonCheckbox">
                                    Challenger Won
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="defenderWonCheckbox">
                                <label class="form-check-label" for="defenderWonCheckbox">
                                    Defender Won
                                </label>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="match-id" name="match_id">
                    <input type="hidden" id="winner-id" name="winner_id">
                    <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Finish Match</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Player Modal -->
<div class="modal fade" id="editPlayerModal" tabindex="-1" aria-labelledby="editPlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPlayerModalLabel">Edit Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/trainer/player_edit" id="editPlayerForm">
                    <!-- Player Name - always editable -->
                    <div class="mb-3">
                        <label for="editPlayerName" class="form-label">Player Name</label>
                        <input type="text" class="form-control" id="editPlayerName" name="name" required>
                    </div>
                    
                    <!-- Ranking Section -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="changeRankingToggle">
                            <label class="form-check-label" for="changeRankingToggle">
                                <strong>Change Ranking</strong>
                            </label>
                        </div>
                        <div id="rankingSection" style="display: none;">
                            <label for="editPlayerRanking" class="form-label">Ranking</label>
                            <input type="number" class="form-control" id="editPlayerRanking" name="ranking" min="1">
                        </div>
                    </div>
                    
                    <!-- Wins/Losses Section -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="changeWinsLossesToggle">
                            <label class="form-check-label" for="changeWinsLossesToggle">
                                <strong>Change Wins & Losses</strong>
                            </label>
                        </div>
                        <div id="winsLossesSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editPlayerWins" class="form-label">Wins</label>
                                        <input type="number" class="form-control" id="editPlayerWins" name="wins" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editPlayerLosses" class="form-label">Losses</label>
                                        <input type="number" class="form-control" id="editPlayerLosses" name="losses" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sets Won/Lost Section -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="changeSetsToggle">
                            <label class="form-check-label" for="changeSetsToggle">
                                <strong>Change Sets Won & Lost</strong>
                            </label>
                        </div>
                        <div id="setsSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editPlayerSetsWon" class="form-label">Sets Won</label>
                                        <input type="number" class="form-control" id="editPlayerSetsWon" name="sets_won" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editPlayerSetsLost" class="form-label">Sets Lost</label>
                                        <input type="number" class="form-control" id="editPlayerSetsLost" name="sets_lost" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bonus Section -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="changeBonusToggle">
                            <label class="form-check-label" for="changeBonusToggle">
                                <strong>Change Bonus</strong>
                            </label>
                        </div>
                        <div id="editBonusSection" style="display: none;">
                            <div class="mb-3">
                                <label for="editBonus" class="form-label">Bonus Points</label>
                                <input type="number" class="form-control" id="editBonus" name="bonus" placeholder="Enter bonus points" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Bonus Condition</label>
                                <div class="input-group">
                                    <span class="input-group-text">Opponent Ranking</span>
                                    <select class="form-select" id="editLogicOperator" name="logic_operator">
                                        <option value="">Select condition</option>
                                        <option value="=">=</option>
                                        <option value="<"><</option>
                                        <option value="<=">≤</option>
                                        <option value=">">></option>
                                        <option value=">=">≥</option>
                                    </select>
                                    <input type="number" class="form-control" id="editLimitRanking" name="limit_ranking" placeholder="Enter ranking limit" min="1">
                                </div>
                            </div>
                            <div class="alert alert-info small" role="alert">
                                <strong>Example:</strong> If you set bonus "5", condition "≤", and limit "3", the player will get 5 bonus points when the opponent's ranking is 3 or better (1, 2, or 3).
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="editPlayerId" name="player_id">
                    <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="/trainer/player_delete" class="me-auto d-inline">
                    <input type="hidden" name="player_id" id="deletePlayerId">
                    <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
                    <!-- Changed: Delete Player button now triggers a choice modal -->
                    <button type="button" class="btn btn-outline-danger" id="deletePlayerBtn">Delete/Remove Player</button>
                    <button type="submit" class="btn btn-danger d-none" id="confirmDeleteBtn">Confirm Delete</button>
                </form>
                <!-- New: Remove Player form, hidden by default -->
                <form method="post" action="/trainer/player_remove" class="d-inline" id="removePlayerForm" style="display:none;">
                    <input type="hidden" name="player_id" id="removePlayerId">
                    <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
                </form>
                <button type="button" class="btn btn-primary" id="savePlayerBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmDeletePlayerModalBody">
                <div class="d-flex align-items-center mb-3">
                    <span class="material-icons text-danger me-2" style="font-size: 24px;">warning</span>
                    <strong>Are you sure you want to delete this player?</strong>
                </div>
                <p class="mb-0">Player: <span id="deletePlayerNameConfirm" class="fw-bold"></span></p>
                <p class="text-muted small mb-0">This action can not be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePlayer" onclick="startSpinner(confirmDeletePlayerModalBody)">Delete Player</button>
            </div>
        </div>
    </div>
</div>

<!-- New: Delete/Remove Choice Modal -->
<div class="modal fade" id="deleteRemoveChoiceModal" tabindex="-1" aria-labelledby="deleteRemoveChoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRemoveChoiceModalLabel">Delete or Remove Player?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Do you want to <strong>delete</strong> this player from the database entirely, or just <strong>remove</strong> them from this ranking?</p>
                <p class="mb-0">Player: <span id="deleteRemovePlayerName" class="fw-bold"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePlayerBtn">Delete Player</button>
                <button type="button" class="btn btn-warning" id="confirmRemovePlayerBtn">Remove from Ranking</button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Container -->
<div class="container-fluid">
    <div class="row">
        <!-- Table Section -->
        <div class="col-12 col-lg-8 mb-4">
            <!-- Add ranking indicator above the table -->
            <div class="d-flex align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <span class="material-icons text-muted me-2" style="font-size: 20px;">sort</span>
                    <span class="text-muted">Ranked by: </span>
                    {% if ranking.sortedBy == "standard" %}
                        <span class="badge bg-primary ms-1">Position</span>
                    {% else %}
                        <span class="badge bg-success ms-1">Points</span>
                    {% endif %}

                    {% if ranking.ended == True %}
                        <span class="badge bg-warning mx-2">Ended</span>
                    {% endif %}
                    
                    <!-- Days left until ranking ends -->
                    {% if ranking.endsOn and not ranking.ended %}
                      {% set days_left = ((ranking.endsOn - now()).total_seconds() / 86400) | int %}
                      {% if days_left >= 0 %}
                        <span class="badge bg-info text-white ms-2">
                          <span class="material-icons me-1" style="font-size: 16px; vertical-align: -0.1em;">schedule</span>
                          {% if days_left == 0 %}
                            Ends today
                          {% elif days_left == 1 %}
                            {{ days_left }} day left
                          {% else %}
                            {{ days_left }} days left
                          {% endif %}
                        </span>
                      {% endif %}
                    {% endif %}
                </div>
            </div>
            <div class="table-responsive" style="max-height: 70vh;">
                <table class="table table-striped table-hover" id="playerTable">
                    <thead class="table-dark sticky-top">
                        <tr>
                            {% if ranking.sortedBy == "standard" %}
                            <th>
                                <div class="d-flex align-items-center">
                                    <span class="material-icons me-1" style="font-size: 16px;">military_tech</span>
                                    Ranking
                                </div>
                            </th>
                            {% else %}
                            <th>
                                <div class="d-flex align-items-center">
                                    <span class="material-icons me-1" style="font-size: 16px;">trending_up</span>
                                    Position
                                </div>
                            </th>
                            {% endif %}
                            <th>Player</th>
                            <th>Points</th>
                            <th>Wins</th>
                            <th>Losses</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in players %}
                        <tr class="player-row" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">
                            {% if ranking.sortedBy == "standard" %}
                            <td><strong>{{ player.ranking }}</strong></td>
                            {% else %}
                            <td><strong>{{ loop.index }}</strong></td>
                            {% endif %}
                            <td>{{ player.name }}</td>
                            <td>{{ player.points }}</td>
                            <td>{{ player.wins }}</td>
                            <td>{{ player.losses }}</td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-primary btn-sm challenge-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#challengeWindow"
                                            data-player-id="{{ player.id }}"
                                            data-player-name="{{ player.name }}"
                                            title="Challenge"
                                            {% if ranking.ended == True %} disabled {% endif %}>
                                        <span class="material-symbols-outlined px-2" style="font-size: 20px;">swords</span>
                                    </button>
                                    <button class="btn btn-secondary btn-sm edit-btn" 
                                            data-bs-toggle="modal"
                                            data-bs-target="#editPlayerModal"
                                            data-player-id="{{ player.id }}"
                                            data-player-name="{{ player.name }}"
                                            data-player-ranking="{{ player.ranking }}"
                                            data-player-wins="{{ player.wins }}"
                                            data-player-losses="{{ player.losses }}"
                                            data-player-sets-won="{{ player.setsWon }}"
                                            data-player-sets-lost="{{ player.setsLost }}"
                                            data-player-bonus="{{ player.bonus.bonus if player.bonus else '' }}"
                                            data-player-logic-operator="{{ player.bonus.logicOperator if player.bonus else '' }}"
                                            data-player-limit-ranking="{{ player.bonus.limitRanking if player.bonus else '' }}"
                                            title="Edit"
                                            {% if ranking.ended == True %} disabled {% endif %}>
                                        <span class="material-icons px-2" style="font-size: 20px;">edit</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Side Section -->
        <div class="col-12 col-lg-4">
            <!-- Active Challenges Section -->
            <div class="mb-4">
            <div class="d-flex align-items-center mb-3">
                <h4 class="mb-0 me-2">Active Challenges</h4>
                <hr class="flex-grow-1">
                <button type="button" class="btn btn-outline-secondary btn-sm" 
                    data-bs-toggle="offcanvas" 
                    data-bs-target="#activeMatchesSettings" 
                    aria-controls="activeMatchesSettings"
                    data-bs-toggle="tooltip" 
                    title="Settings"
                    {% if ranking.ended == True %} disabled {% endif %}>
                <span class="material-icons" style="font-size: 16px;">settings</span>
                </button>
            </div>
            <div class="activeMatches">
                {% if activeMatches %}
                <div id="activeMatchesCarousel" class="carousel slide">
                    <div class="carousel-inner">
                    <div class="carousel-item active">
                        <div class="bg-light p-3 rounded text-center">
                        <div class="row align-items-center">
                            <div class="col">
                            <h5>{{ activeMatches[0].challenger }}</h5>
                            </div>
                            <div class="col-auto">
                            <span class="badge bg-primary">vs</span>
                            </div>
                            <div class="col">
                            <h5>{{ activeMatches[0].defender }}</h5>
                            </div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col">
                            {% if activeMatches[0].challengerBonus and activeMatches[0].challengerBonus != 0 %}
                                {% if activeMatches[0].challengerBonus > 0 %}
                                <span class="badge bg-success p-1.5 fs-6">+
                                {% elif activeMatches[0].challengerBonus < 0 %}
                                <span class="badge bg-danger p-1.5 fs-6">
                                {% endif %}
                                {{ activeMatches[0].challengerBonus }}
                                </span>
                            {% endif %}
                            </div>
                            <div class="col-auto">
                            <span></span>
                            </div>
                            <div class="col">
                            {% if activeMatches[0].defenderBonus and activeMatches[0].defenderBonus != 0 %}
                                {% if activeMatches[0].defenderBonus > 0 %}
                                <span class="badge bg-success p-1.5 fs-6">+
                                {% elif activeMatches[0].defenderBonus < 0 %}
                                <span class="badge bg-danger p-1.5 fs-6">
                                {% endif %}
                                {{ activeMatches[0].defenderBonus }}
                                </span>
                            {% endif %}
                            </div>
                        </div>
                        <p class="text-muted mb-2" data-start-timestamp="{{ activeMatches[0].timeStarted.timestamp() }}">
                            Since: {{ activeMatches[0].timeStarted.strftime('%H:%M') }}
                        </p>
                        <button type="button" class="btn btn-primary btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#finishMatchModal"
                            data-match-id="{{ activeMatches[0].id }}"
                            data-challenger-name="{{ activeMatches[0].challenger }}"
                            data-defender-name="{{ activeMatches[0].defender }}"
                            data-challenger-id="{{ activeMatches[0].challengerId }}"
                            data-defender-id="{{ activeMatches[0].defenderId }}"
                            {% if ranking.ended == True %} disabled {% endif %}>
                            Finish Match
                        </button>
                        </div>
                    </div>
                    {% for match in activeMatches[1:] %}
                        <div class="carousel-item">
                        <div class="bg-light p-3 rounded text-center">
                            <div class="row align-items-center">
                            <div class="col">
                                <h5>{{ match.challenger }}</h5>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-primary">vs</span>
                            </div>
                            <div class="col">
                                <h5>{{ match.defender }}</h5>
                            </div>
                            </div>
                            <div class="row align-items-center">
                            <div class="col">
                                {% if match.challengerBonus and match.challengerBonus != 0 %}
                                {% if match.challengerBonus > 0 %}
                                    <span class="badge bg-success p-1.5 fs-6">+
                                {% elif match.challengerBonus < 0 %}
                                    <span class="badge bg-danger p-1.5 fs-6">
                                {% endif %}
                                {{ match.challengerBonus }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="col-auto">
                                <span></span>
                            </div>
                            <div class="col">
                                {% if match.defenderBonus and match.defenderBonus != 0 %}
                                {% if match.defenderBonus > 0 %}
                                    <span class="badge bg-success p-1.5 fs-6">+
                                {% elif match.defenderBonus < 0 %}
                                    <span class="badge bg-danger p-1.5 fs-6">
                                {% endif %}
                                {{ match.defenderBonus }}
                                </span>
                                {% endif %}
                            </div>
                            </div>
                            <p class="text-muted mb-2" data-start-timestamp="{{ match.timeStarted.timestamp() }}">
                            Since: {{ match.timeStarted.strftime('%H:%M') }}
                            </p>
                            <button type="button" class="btn btn-primary btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#finishMatchModal"
                                data-match-id="{{ match.id }}"
                                data-challenger-name="{{ match.challenger }}"
                                data-defender-name="{{ match.defender }}"
                                data-challenger-id="{{ match.challengerId }}"
                                data-defender-id="{{ match.defenderId }}"
                                {% if ranking.ended == True %} disabled {% endif %}>
                            Finish Match
                            </button>
                        </div>
                        </div>
                    {% endfor %}
                    </div>
                    {% if activeMatches|length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#activeMatchesCarousel" data-bs-slide="prev" {% if ranking.ended == True %} disabled {% endif %}>
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#activeMatchesCarousel" data-bs-slide="next" {% if ranking.ended == True %} disabled {% endif %}>
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
                {% else %}
                <div class="bg-light p-3 rounded text-center text-muted">
                    <p class="mb-0">There are currently no active challenges.</p>
                </div>
                {% endif %}
            </div>
            </div>
            
            <!-- Add Player Section -->
            <div class="mb-4">
            <div class="d-flex align-items-center mb-3">
                <h4 class="mb-0 me-2">Add Player</h4>
                <hr class="flex-grow-1">
                <button type="button" class="btn btn-outline-secondary btn-sm" 
                    data-bs-toggle="offcanvas" 
                    data-bs-target="#addPlayerOffcanvas" 
                    aria-controls="addPlayerOffcanvas"
                    data-bs-toggle="tooltip" 
                    title="Add Player"
                    {% if ranking.ended == True %} disabled {% endif %}>
                <span class="material-icons" style="font-size: 16px;">add</span>
                </button>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Player Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="addPlayerOffcanvas" aria-labelledby="addPlayerOffcanvasLabel" style="width: 500px;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="addPlayerOffcanvasLabel">Add New Player</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <!-- Step 1: Choose Add or Import -->
        <div id="addPlayerChoiceSection">
            <div class="mb-4">
                <label class="form-label"><strong>How do you want to add a player?</strong></label>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" id="chooseNewPlayerBtn">Completely New Player</button>
                    <button type="button" class="btn btn-secondary" id="chooseImportPlayerBtn">Import Existing Signup</button>
                </div>
            </div>
        </div>
        <!-- Step 2a: New Player Form -->
        <form method="post" action="/trainer/player_add" id="addPlayerForm" style="display: none;">
            <div class="mb-3">
                <label for="playerName" class="form-label">Player Name</label>
                <input type="text" class="form-control" id="playerName" name="name" placeholder="Enter player name" required>
            </div>
            <div class="mb-3">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="addBonusToggle">
                    <label class="form-check-label" for="addBonusToggle">
                        <strong>Add Bonus (Optional)</strong>
                    </label>
                </div>
                <div id="bonusSection" style="display: none;">
                    <div class="mb-3">
                        <label for="bonus" class="form-label">Bonus Points</label>
                        <input type="number" class="form-control" id="bonus" name="bonus" placeholder="Enter bonus points" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bonus Condition</label>
                        <div class="input-group">
                            <span class="input-group-text">Opponent Ranking</span>
                            <select class="form-select" id="logicOperator" name="logic_operator">
                                <option value="">Select condition</option>
                                <option value="=">=</option>
                                <option value="<"><</option>
                                <option value="<=">≤</option>
                                <option value=">">></option>
                                <option value=">=">≥</option>
                            </select>
                            <input type="number" class="form-control" id="limitRanking" name="limit_ranking" placeholder="Enter ranking limit" min="1">
                        </div>
                    </div>
                    <div class="alert alert-info small" role="alert">
                        <strong>Example:</strong> If you set bonus "5", condition "≤", and limit "3", the player will get 5 bonus points when the opponent's ranking is 3 or better (1, 2, or 3).
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Add Player</button>
            <button type="button" class="btn btn-link w-100 mt-2" id="backToChoiceFromNew">Back</button>

            <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
        </form>
        <!-- Step 2b: Import Player Form -->
        <form method="post" action="/trainer/player_import" id="importPlayerForm" style="display: none;">
            <div class="mb-3">
                <label for="importPlayerSelect" class="form-label">Select Existing Signup</label>
                <select class="form-select" id="importPlayerSelect" name="import_player_id" required>
                    <option value="">Choose player...</option>
                    {% for signup in allPlayers %}
                        {% if signup.id not in players|map(attribute='id')|list %}
                            <option value="{{ signup.id }}">{{ signup.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-success w-100">Import Player</button>
            <button type="button" class="btn btn-link w-100 mt-2" id="backToChoiceFromImport">Back</button>
            <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
        </form>
    </div>
</div>

<!-- Active Matches Settings Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="activeMatchesSettings" aria-labelledby="activeMatchesSettingsLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="activeMatchesSettingsLabel">Display Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="mb-3">
            <label for="displayMode" class="form-label">Display Mode</label>
            <select class="form-select" id="displayMode">
                <option value="carousel">Carousel</option>
                <option value="grid">Grid View</option>
            </select>
        </div>
        
        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showElapsed">
                <label class="form-check-label" for="showElapsed">
                    Show elapsed time
                </label>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefresh">
                <label class="form-check-label" for="autoRefresh">
                    Auto-refresh (30s)
                </label>
            </div>
        </div>
        
        <button type="button" class="btn btn-primary w-100" id="applySettings">Apply Settings</button>
    </div>
</div>

{% endblock %}