{% extends "base.html" %}

{% block content %}
<h1>{{ ranking.name }}</h1>

<!-- Challenge Modal -->
<div class="modal fade" id="challengeWindow" tabindex="-1" aria-labelledby="challengeWindowLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h1 class="modal-title fs-5 d-flex align-items-center" id="challengeWindowLabel">
                    <span class="material-symbols-outlined me-2">swords</span>
                    Start Challenge
                </h1>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="challenger-info text-center">
                            <span class="material-symbols-outlined text-primary mb-2" style="font-size: 2rem;">person</span>
                            <h5 class="mb-0" id="challengerName">Challenger</h5>
                            <small class="text-muted">challenges</small>
                        </div>
                        <div class="mx-4">
                            <span class="material-symbols-outlined text-muted" style="font-size: 2rem;">trending_flat</span>
                        </div>
                        <div class="defender-info text-center">
                            <span class="material-symbols-outlined text-secondary mb-2" style="font-size: 2rem;">shield</span>
                            <h5 class="mb-0 text-muted">Select Defender</h5>
                        </div>
                    </div>
                </div>

                <form method="post" action="/trainer/start_match" id="challengeForm">
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <span class="material-symbols-outlined me-2" style="font-size: 18px;">search</span>
                            Choose defender to challenge:
                        </label>
                        
                        <!-- Search input with improved styling -->
                        <div class="position-relative">
                            <input type="text" 
                                class="form-control form-control-lg" 
                                placeholder="Search for a player..." 
                                id="defenderSearch"
                                autocomplete="off"
                                style="padding-left: 3rem; min-height: 48px;">
                            <span class="material-symbols-outlined position-absolute top-50 start-0 translate-middle-y ms-3 text-muted">
                                search
                            </span>
                        </div>

                        <!-- Player selection cards -->
                        <div class="player-selection-container mt-3" id="playerCards" style="max-height: 300px; overflow-y: auto;">
                            <!-- Player cards will be populated here -->
                        </div>
                    </div>

                    <input type="hidden" id="challenger-id" name="challenger_id">
                    <input type="hidden" id="defender-id" name="defender_id">
                    <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span class="material-symbols-outlined me-1" style="font-size: 16px;">close</span>
                    Cancel
                </button>
                <button type="button" class="btn btn-success" id="startChallengeBtn" disabled>
                    <span class="material-symbols-outlined me-1" style="font-size: 16px;">play_arrow</span>
                    Start Challenge
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced challenge modal styling */
.player-card {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
    min-height: 48px; /* Touch-friendly height */
}

.player-card:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.player-card.selected {
    border-color: #28a745;
    background-color: #d4edda;
    color: #155724;
}

.player-card.selected .material-symbols-outlined {
    color: #28a745;
}

.player-card-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.player-info {
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.player-stats {
    display: flex;
    gap: 16px;
    font-size: 0.9rem;
    color: #6c757d;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Touch-friendly improvements for tablets */
@media (max-width: 991.98px) {
    .player-card {
        min-height: 56px;
        padding: 16px;
    }
    
    .modal-dialog {
        margin: 1rem;
    }
    
    .form-control-lg {
        min-height: 56px !important;
        font-size: 16px; /* Prevent zoom on iOS */
    }
}

/* Search input focus effects */
#defenderSearch:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

/* Empty state styling */
.empty-state {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.empty-state .material-symbols-outlined {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const defenderSearch = document.getElementById('defenderSearch');
    const playerCards = document.getElementById('playerCards');
    const startChallengeBtn = document.getElementById('startChallengeBtn');
    const challengerIdInput = document.getElementById('challenger-id');
    const defenderIdInput = document.getElementById('defender-id');
    const challengeForm = document.getElementById('challengeForm');
    
    let selectedDefenderId = null;
    let challengerId = null;
    let challengerPosition = null;
    let allPlayers = [];
    
    // Get ranking type from backend
    const rankingSortedBy = "{{ ranking.sortedBy }}";

    // Initialize with player data from the table
    function initializePlayers() {
        const playerRows = document.querySelectorAll('.player-row');
        allPlayers = Array.from(playerRows).map((row, index) => ({
            id: row.dataset.playerId,
            name: row.dataset.playerName,
            position: index + 1, // Position is always based on table order (1-based)
            displayRanking: row.cells[0].textContent.trim(), // What's shown in the table
            points: row.cells[2].textContent.trim(),
            wins: row.cells[3].textContent.trim(),
            losses: row.cells[4].textContent.trim()
        }));
    }

    // Get eligible defenders (higher positions = lower position numbers)
    function getEligibleDefenders(challengerPos) {
        return allPlayers.filter(player => 
            player.id !== challengerId && 
            player.position < challengerPos // Lower position number = higher ranking
        );
    }

    // Render player cards
    function renderPlayerCards(players) {
        if (players.length === 0) {
            playerCards.innerHTML = `
                <div class="empty-state">
                    <span class="material-symbols-outlined">search_off</span>
                    <p class="mb-0">No eligible players found</p>
                    <small class="text-muted">Only players with higher positions can be challenged</small>
                </div>
            `;
            return;
        }

        playerCards.innerHTML = players.map(player => {
            const rankingDisplay = rankingSortedBy === "standard" 
                ? `Rank ${player.displayRanking}`
                : `Position ${player.position}`;
                
            return `
                <div class="player-card" 
                     data-player-id="${player.id}" 
                     data-player-name="${player.name}">
                    <div class="player-card-content">
                        <div class="player-info">
                            <span class="material-symbols-outlined me-3 text-primary">person</span>
                            <div>
                                <div class="fw-bold">${player.name}</div>
                                <small class="text-muted">${rankingDisplay}</small>
                            </div>
                        </div>
                        <div class="player-stats">
                            <div class="stat-item">
                                <span class="material-symbols-outlined" style="font-size: 16px;">trending_up</span>
                                <span>${player.points}</span>
                            </div>
                            <div class="stat-item">
                                <span class="material-symbols-outlined" style="font-size: 16px;">check_circle</span>
                                <span>${player.wins}</span>
                            </div>
                            <div class="stat-item">
                                <span class="material-symbols-outlined" style="font-size: 16px;">cancel</span>
                                <span>${player.losses}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Add click handlers to player cards
        playerCards.querySelectorAll('.player-card').forEach(card => {
            card.addEventListener('click', function() {
                selectDefender(this.dataset.playerId, this.dataset.playerName);
            });
        });
    }

    // Filter players based on search (within eligible defenders)
    function filterPlayers(searchTerm) {
        const eligibleDefenders = getEligibleDefenders(challengerPosition);
        const filtered = eligibleDefenders.filter(player => 
            player.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
        renderPlayerCards(filtered);
    }

    // Select defender
    function selectDefender(playerId, playerName) {
        // Remove previous selection
        playerCards.querySelectorAll('.player-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Add selection to clicked card
        const selectedCard = playerCards.querySelector(`[data-player-id="${playerId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }

        selectedDefenderId = playerId;
        defenderIdInput.value = playerId;
        
        // Update defender info display
        document.querySelector('.defender-info h5').textContent = playerName;
        document.querySelector('.defender-info h5').classList.remove('text-muted');
        document.querySelector('.defender-info .material-symbols-outlined').classList.remove('text-secondary');
        document.querySelector('.defender-info .material-symbols-outlined').classList.add('text-success');

        // Enable start button
        startChallengeBtn.disabled = false;
    }

    // Search functionality
    defenderSearch.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        filterPlayers(searchTerm);
    });

    // Handle challenge button clicks
    document.querySelectorAll('.challenge-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            challengerId = this.dataset.playerId;
            const challengerName = this.dataset.playerName;
            
            // Find challenger's position based on table row index
            const challengerRow = document.querySelector(`[data-player-id="${challengerId}"]`);
            const allRows = Array.from(document.querySelectorAll('.player-row'));
            challengerPosition = allRows.indexOf(challengerRow) + 1; // 1-based position
            
            challengerIdInput.value = challengerId;
            document.getElementById('challengerName').textContent = challengerName;
            
            // Reset form
            defenderSearch.value = '';
            selectedDefenderId = null;
            defenderIdInput.value = '';
            startChallengeBtn.disabled = true;
            
            // Reset defender info display
            document.querySelector('.defender-info h5').textContent = 'Select Defender';
            document.querySelector('.defender-info h5').classList.add('text-muted');
            document.querySelector('.defender-info .material-symbols-outlined').classList.remove('text-success');
            document.querySelector('.defender-info .material-symbols-outlined').classList.add('text-secondary');
            
            // Initialize and render eligible defenders only
            initializePlayers();
            const eligibleDefenders = getEligibleDefenders(challengerPosition);
            renderPlayerCards(eligibleDefenders);
        });
    });

    // Start challenge
    startChallengeBtn.addEventListener('click', function() {
        if (!selectedDefenderId) {
            return;
        }
        
        challengeForm.submit();
    });

    // Handle cancel match button
    document.getElementById('cancelMatchBtn').addEventListener('click', function() {
        const matchId = document.getElementById('match-id').value;
        const cancelInput = document.getElementById('cancel-match');
        const finishMatchForm = document.getElementById('finishMatchForm');
        
        // Set the cancel flag
        cancelInput.value = 'true';
        
        // Submit the form
        finishMatchForm.submit();
    });

    // Also update the finish match modal setup to populate the match data
    document.querySelectorAll('[data-bs-target="#finishMatchModal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const matchId = this.dataset.matchId;
            const challengerName = this.dataset.challengerName;
            const defenderName = this.dataset.defenderName;
            const challengerId = this.dataset.challengerId;
            const defenderId = this.dataset.defenderId;
            
            // Update modal content
            document.getElementById('match-id').value = matchId;
            document.querySelector('label[for="inputChallengerSetsWon"]').textContent = challengerName;
            document.querySelector('label[for="inputDefenderSetsWon"]').textContent = defenderName;
            
            // Reset form
            document.getElementById('inputChallengerSetsWon').value = '';
            document.getElementById('inputDefenderSetsWon').value = '';
            document.getElementById('challengerWonCheckbox').checked = false;
            document.getElementById('defenderWonCheckbox').checked = false;
            document.getElementById('cancel-match').value = '';
            document.getElementById('winner-id').value = '';
            document.getElementById('finishMatchBtn').disabled = false;
        });
    });

    // Initialize on page load
    initializePlayers();
});
</script>

<!-- Finish Match Modal -->
<div class="modal fade" id="finishMatchModal" tabindex="-1" aria-labelledby="finishMatchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finishMatchModalLabel">Finish Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="finishMatchModalContent">
                <form method="post" action="/trainer/finish_match" id="finishMatchForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="inputChallengerSetsWon" class="form-label">Challenger Name</label>
                            <input type="number" class="form-control" placeholder="Challenger sets won" aria-label="Challenger sets won" id="inputChallengerSetsWon" name="challenger_score">
                        </div>
                        <div class="col-md-6">
                            <label for="inputDefenderSetsWon" class="form-label">Defender Name</label>
                            <input type="number" class="form-control" placeholder="Defender sets won" aria-label="Defender sets won" id="inputDefenderSetsWon" name="defender_score">
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="challengerWonCheckbox">
                                <label class="form-check-label" for="challengerWonCheckbox">
                                    Challenger Won
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="defenderWonCheckbox">
                                <label class="form-check-label" for="defenderWonCheckbox">
                                    Defender Won
                                </label>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="match-id" name="match_id">
                    <input type="hidden" id="winner-id" name="winner_id">
                    <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
                    <input type="hidden" id="cancel-match" name="cancel" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="cancelMatchBtn">
                    <span class="material-icons me-1" style="font-size: 16px;">cancel</span>
                    Cancel Match
                </button>
                <button type="button" class="btn btn-primary" id="finishMatchBtn">
                    <span class="material-icons me-1" style="font-size: 16px;">check</span>
                    Finish Match
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Player Modal -->
<div class="modal fade" id="editPlayerModal" tabindex="-1" aria-labelledby="editPlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPlayerModalLabel">Edit Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/trainer/player_edit" id="editPlayerForm">
                    <!-- Player Name - always editable -->
                    <div class="mb-3">
                        <label for="editPlayerName" class="form-label">Player Name</label>
                        <input type="text" class="form-control" id="editPlayerName" name="name" required>
                    </div>
                    
                    <!-- Ranking Section -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="changeRankingToggle">
                            <label class="form-check-label" for="changeRankingToggle">
                                <strong>Change Ranking</strong>
                            </label>
                        </div>
                        <div id="rankingSection" style="display: none;">
                            <label for="editPlayerRanking" class="form-label">Ranking</label>
                            <input type="number" class="form-control" id="editPlayerRanking" name="ranking" min="1">
                        </div>
                    </div>
                    
                    <!-- Wins/Losses Section -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="changeWinsLossesToggle">
                            <label class="form-check-label" for="changeWinsLossesToggle">
                                <strong>Change Wins & Losses</strong>
                            </label>
                        </div>
                        <div id="winsLossesSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editPlayerWins" class="form-label">Wins</label>
                                        <input type="number" class="form-control" id="editPlayerWins" name="wins" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editPlayerLosses" class="form-label">Losses</label>
                                        <input type="number" class="form-control" id="editPlayerLosses" name="losses" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sets Won/Lost Section -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="changeSetsToggle">
                            <label class="form-check-label" for="changeSetsToggle">
                                <strong>Change Sets Won & Lost</strong>
                            </label>
                        </div>
                        <div id="setsSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editPlayerSetsWon" class="form-label">Sets Won</label>
                                        <input type="number" class="form-control" id="editPlayerSetsWon" name="sets_won" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editPlayerSetsLost" class="form-label">Sets Lost</label>
                                        <input type="number" class="form-control" id="editPlayerSetsLost" name="sets_lost" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bonus Section -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="changeBonusToggle">
                            <label class="form-check-label" for="changeBonusToggle">
                                <strong>Change Bonus</strong>
                            </label>
                        </div>
                        <div id="editBonusSection" style="display: none;">
                            <div class="mb-3">
                                <label for="editBonus" class="form-label">Bonus Points</label>
                                <input type="number" class="form-control" id="editBonus" name="bonus" placeholder="Enter bonus points" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Bonus Condition</label>
                                <div class="input-group">
                                    <span class="input-group-text">Opponent Ranking</span>
                                    <select class="form-select" id="editLogicOperator" name="logic_operator">
                                        <option value="">Select condition</option>
                                        <option value="=">=</option>
                                        <option value="<"><</option>
                                        <option value="<=">≤</option>
                                        <option value=">">></option>
                                        <option value=">=">≥</option>
                                    </select>
                                    <input type="number" class="form-control" id="editLimitRanking" name="limit_ranking" placeholder="Enter ranking limit" min="1">
                                </div>
                            </div>
                            <div class="alert alert-info small" role="alert">
                                <strong>Example:</strong> If you set bonus "5", condition "≤", and limit "3", the player will get 5 bonus points when the opponent's ranking is 3 or better (1, 2, or 3).
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="editPlayerId" name="player_id">
                    <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <div class="me-auto">
                    <button type="button" class="btn btn-outline-danger" id="deletePlayerBtn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteRemoveChoiceModal">
                        Delete/Remove Player
                    </button>
                </div>
                <button type="button" class="btn btn-primary" id="savePlayerBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmDeletePlayerModalBody">
                <div class="d-flex align-items-center mb-3">
                    <span class="material-icons text-danger me-2" style="font-size: 24px;">warning</span>
                    <strong>Are you sure you want to delete this player?</strong>
                </div>
                <p class="mb-0">Player: <span id="deletePlayerNameConfirm" class="fw-bold"></span></p>
                <p class="text-muted small mb-0">This action can not be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePlayer" onclick="startSpinner(confirmDeletePlayerModalBody)">Delete Player</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete/Remove Choice Modal -->
<div class="modal fade" id="deleteRemoveChoiceModal" tabindex="-1" aria-labelledby="deleteRemoveChoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRemoveChoiceModalLabel">Delete or Remove Player?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Do you want to <strong>delete</strong> this player from the database entirely, or just <strong>remove</strong> them from this ranking?</p>
                <p class="mb-0">Player: <span id="deleteRemovePlayerName" class="fw-bold"></span></p>
                <div class="mt-3">
                    <div class="alert alert-danger small mb-2">
                        <strong>Delete:</strong> Removes player completely from database. Cannot be undone.
                    </div>
                    <div class="alert alert-warning small mb-0">
                        <strong>Remove:</strong> Only removes player from this ranking. Player data preserved.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmRemovePlayerBtn">
                    <span class="material-icons me-1" style="font-size: 16px;">person_remove</span>
                    Remove from Ranking
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeletePlayerBtn">
                    <span class="material-icons me-1" style="font-size: 16px;">delete_forever</span>
                    Delete Player
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for deleting a player -->
<form id="deletePlayerForm" method="post" action="/trainer/player_delete" style="display:none;">
    <input type="hidden" name="player_id" id="deletePlayerId">
    <input type="hidden" name="rankingId" value="{{ rankingId }}">
</form>
<!-- Hidden form for removing a player from ranking -->
<form id="removePlayerForm" method="post" action="/trainer/player_remove" style="display:none;">
    <input type="hidden" name="player_id" id="removePlayerId">
    <input type="hidden" name="rankingId" value="{{ rankingId }}">
</form>

<!-- Main Content Container -->
<div class="container-fluid">
    <div class="row">
        <!-- Table Section -->
        <div class="col-12 col-lg-8 mb-4">
            <!-- Add ranking indicator above the table -->
            <div class="d-flex align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <span class="material-icons text-muted me-2" style="font-size: 20px;">sort</span>
                    <span class="text-muted">Ranked by: </span>
                    {% if ranking.sortedBy == "standard" %}
                        <span class="badge bg-primary ms-1">Position</span>
                    {% else %}
                        <span class="badge bg-success ms-1">Points</span>
                    {% endif %}

                    {% if ranking.ended == True %}
                        <span class="badge bg-warning mx-2">Ended</span>
                    {% endif %}
                    
                    <!-- Days left until ranking ends -->
                    {% if ranking.endsOn and not ranking.ended %}
                      {% set days_left = ((ranking.endsOn - now()).total_seconds() / 86400) | int %}
                      {% if days_left >= 0 %}
                        <span class="badge bg-info text-white ms-2">
                          <span class="material-icons me-1" style="font-size: 16px; vertical-align: -0.1em;">schedule</span>
                          {% if days_left == 0 %}
                            Ends today
                          {% elif days_left == 1 %}
                            {{ days_left }} day left
                          {% else %}
                            {{ days_left }} days left
                          {% endif %}
                        </span>
                      {% endif %}
                    {% endif %}
                </div>
            </div>
            <div class="table-responsive" style="max-height: 70vh;">
                <table class="table table-striped table-hover" id="playerTable">
                    <thead class="table-dark sticky-top">
                        <tr>
                            {% if ranking.sortedBy == "standard" %}
                            <th>
                                <div class="d-flex align-items-center">
                                    <span class="material-icons me-1" style="font-size: 16px;">military_tech</span>
                                    Ranking
                                </div>
                            </th>
                            {% else %}
                            <th>
                                <div class="d-flex align-items-center">
                                    <span class="material-icons me-1" style="font-size: 16px;">trending_up</span>
                                    Position
                                </div>
                            </th>
                            {% endif %}
                            <th>Player</th>
                            <th>Points</th>
                            <th>Wins</th>
                            <th>Losses</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in players %}
                        <tr class="player-row" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">
                            {% if ranking.sortedBy == "standard" %}
                            <td><strong>{{ player.ranking }}</strong></td>
                            {% else %}
                            <td><strong>{{ loop.index }}</strong></td>
                            {% endif %}
                            <td>{{ player.name }}</td>
                            <td>{{ player.points }}</td>
                            <td>{{ player.wins }}</td>
                            <td>{{ player.losses }}</td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-primary btn-sm challenge-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#challengeWindow"
                                            data-player-id="{{ player.id }}"
                                            data-player-name="{{ player.name }}"
                                            title="Challenge"
                                            {% if ranking.ended == True %} disabled {% endif %}>
                                        <span class="material-symbols-outlined px-2" style="font-size: 20px;">swords</span>
                                    </button>
                                    <button class="btn btn-secondary btn-sm edit-btn" 
                                            data-bs-toggle="modal"
                                            data-bs-target="#editPlayerModal"
                                            data-player-id="{{ player.id }}"
                                            data-player-name="{{ player.name }}"
                                            data-player-ranking="{{ player.ranking }}"
                                            data-player-wins="{{ player.wins }}"
                                            data-player-losses="{{ player.losses }}"
                                            data-player-sets-won="{{ player.setsWon }}"
                                            data-player-sets-lost="{{ player.setsLost }}"
                                            data-player-bonus="{{ player.bonus.bonus if player.bonus else '' }}"
                                            data-player-logic-operator="{{ player.bonus.logicOperator if player.bonus else '' }}"
                                            data-player-limit-ranking="{{ player.bonus.limitRanking if player.bonus else '' }}"
                                            title="Edit"
                                            {% if ranking.ended == True %} disabled {% endif %}>
                                        <span class="material-icons px-2" style="font-size: 20px;">edit</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Side Section -->
        <div class="col-12 col-lg-4">
            <!-- Active Challenges Section -->
            <div class="mb-4">
            <div class="d-flex align-items-center mb-3">
                <h4 class="mb-0 me-2">Active Challenges</h4>
                <hr class="flex-grow-1">
                <button type="button" class="btn btn-outline-secondary btn-sm" 
                    data-bs-toggle="offcanvas" 
                    data-bs-target="#activeMatchesSettings" 
                    aria-controls="activeMatchesSettings"
                    data-bs-toggle="tooltip" 
                    title="Settings"
                    {% if ranking.ended == True %} disabled {% endif %}>
                <span class="material-icons" style="font-size: 16px;">settings</span>
                </button>
            </div>
            <div class="activeMatches">
                {% if activeMatches %}
                <div id="activeMatchesCarousel" class="carousel slide">
                    <div class="carousel-inner">
                    <div class="carousel-item active">
                        <div class="bg-light p-3 rounded text-center">
                        <div class="row align-items-center">
                            <div class="col">
                            <h5>{{ activeMatches[0].challenger }}</h5>
                            </div>
                            <div class="col-auto">
                            <span class="badge bg-primary">vs</span>
                            </div>
                            <div class="col">
                            <h5>{{ activeMatches[0].defender }}</h5>
                            </div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col">
                            {% if activeMatches[0].challengerBonus and activeMatches[0].challengerBonus != 0 %}
                                {% if activeMatches[0].challengerBonus > 0 %}
                                <span class="badge bg-success p-1.5 fs-6">+
                                {% elif activeMatches[0].challengerBonus < 0 %}
                                <span class="badge bg-danger p-1.5 fs-6">
                                {% endif %}
                                {{ activeMatches[0].challengerBonus }}
                                </span>
                            {% endif %}
                            </div>
                            <div class="col-auto">
                            <span></span>
                            </div>
                            <div class="col">
                            {% if activeMatches[0].defenderBonus and activeMatches[0].defenderBonus != 0 %}
                                {% if activeMatches[0].defenderBonus > 0 %}
                                <span class="badge bg-success p-1.5 fs-6">+
                                {% elif activeMatches[0].defenderBonus < 0 %}
                                <span class="badge bg-danger p-1.5 fs-6">
                                {% endif %}
                                {{ activeMatches[0].defenderBonus }}
                                </span>
                            {% endif %}
                            </div>
                        </div>
                        <p class="text-muted mb-2" data-start-timestamp="{{ activeMatches[0].timeStarted.timestamp() }}">
                            Since: {{ activeMatches[0].timeStarted.strftime('%H:%M') }}
                        </p>
                        <button type="button" class="btn btn-primary btn-sm" 
                            data-bs-toggle="modal" 
                            data-bs-target="#finishMatchModal"
                            data-match-id="{{ activeMatches[0].id }}"
                            data-challenger-name="{{ activeMatches[0].challenger }}"
                            data-defender-name="{{ activeMatches[0].defender }}"
                            data-challenger-id="{{ activeMatches[0].challengerId }}"
                            data-defender-id="{{ activeMatches[0].defenderId }}"
                            {% if ranking.ended == True %} disabled {% endif %}>
                            Finish Match
                        </button>
                        </div>
                    </div>
                    {% for match in activeMatches[1:] %}
                        <div class="carousel-item">
                        <div class="bg-light p-3 rounded text-center">
                            <div class="row align-items-center">
                            <div class="col">
                                <h5>{{ match.challenger }}</h5>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-primary">vs</span>
                            </div>
                            <div class="col">
                                <h5>{{ match.defender }}</h5>
                            </div>
                            </div>
                            <div class="row align-items-center">
                            <div class="col">
                                {% if match.challengerBonus and match.challengerBonus != 0 %}
                                {% if match.challengerBonus > 0 %}
                                    <span class="badge bg-success p-1.5 fs-6">+
                                {% elif match.challengerBonus < 0 %}
                                    <span class="badge bg-danger p-1.5 fs-6">
                                {% endif %}
                                {{ match.challengerBonus }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="col-auto">
                                <span></span>
                            </div>
                            <div class="col">
                                {% if match.defenderBonus and match.defenderBonus != 0 %}
                                {% if match.defenderBonus > 0 %}
                                    <span class="badge bg-success p-1.5 fs-6">+
                                {% elif match.defenderBonus < 0 %}
                                    <span class="badge bg-danger p-1.5 fs-6">
                                {% endif %}
                                {{ match.defenderBonus }}
                                </span>
                                {% endif %}
                            </div>
                            </div>
                            <p class="text-muted mb-2" data-start-timestamp="{{ match.timeStarted.timestamp() }}">
                            Since: {{ match.timeStarted.strftime('%H:%M') }}
                            </p>
                            <button type="button" class="btn btn-primary btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#finishMatchModal"
                                data-match-id="{{ match.id }}"
                                data-challenger-name="{{ match.challenger }}"
                                data-defender-name="{{ match.defender }}"
                                data-challenger-id="{{ match.challengerId }}"
                                data-defender-id="{{ match.defenderId }}"
                                {% if ranking.ended == True %} disabled {% endif %}>
                            Finish Match
                            </button>
                        </div>
                        </div>
                    {% endfor %}
                    </div>
                    {% if activeMatches|length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#activeMatchesCarousel" data-bs-slide="prev" {% if ranking.ended == True %} disabled {% endif %}>
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#activeMatchesCarousel" data-bs-slide="next" {% if ranking.ended == True %} disabled {% endif %}>
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
                {% else %}
                <div class="bg-light p-3 rounded text-center text-muted">
                    <p class="mb-0">There are currently no active challenges.</p>
                </div>
                {% endif %}
            </div>
            </div>
            
            <!-- Add Player Section -->
            <div class="mb-4">
            <div class="d-flex align-items-center mb-3">
                <h4 class="mb-0 me-2">Add Player</h4>
                <hr class="flex-grow-1">
                <button type="button" class="btn btn-outline-secondary btn-sm" 
                    data-bs-toggle="offcanvas" 
                    data-bs-target="#addPlayerOffcanvas" 
                    aria-controls="addPlayerOffcanvas"
                    data-bs-toggle="tooltip" 
                    title="Add Player"
                    {% if ranking.ended == True %} disabled {% endif %}>
                <span class="material-icons" style="font-size: 16px;">add</span>
                </button>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Player Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="addPlayerOffcanvas" aria-labelledby="addPlayerOffcanvasLabel" style="width: 500px;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="addPlayerOffcanvasLabel">Add New Player</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <!-- Step 1: Choose Add or Import -->
        <div id="addPlayerChoiceSection">
            <div class="mb-4">
                <label class="form-label"><strong>How do you want to add a player?</strong></label>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" id="chooseNewPlayerBtn">Completely New Player</button>
                    <button type="button" class="btn btn-secondary" id="chooseImportPlayerBtn">Import Existing Signup</button>
                </div>
            </div>
        </div>
        <!-- Step 2a: New Player Form -->
        <form method="post" action="/trainer/player_add" id="addPlayerForm" style="display: none;">
            <div class="mb-3">
                <label for="playerName" class="form-label">Player Name</label>
                <input type="text" class="form-control" id="playerName" name="name" placeholder="Enter player name" required>
            </div>
            <div class="mb-3">
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="addBonusToggle">
                    <label class="form-check-label" for="addBonusToggle">
                        <strong>Add Bonus (Optional)</strong>
                    </label>
                </div>
                <div id="bonusSection" style="display: none;">
                    <div class="mb-3">
                        <label for="bonus" class="form-label">Bonus Points</label>
                        <input type="number" class="form-control" id="bonus" name="bonus" placeholder="Enter bonus points" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bonus Condition</label>
                        <div class="input-group">
                            <span class="input-group-text">Opponent Ranking</span>
                            <select class="form-select" id="logicOperator" name="logic_operator">
                                <option value="">Select condition</option>
                                <option value="=">=</option>
                                <option value="<"><</option>
                                <option value="<=">≤</option>
                                <option value=">">></option>
                                <option value=">=">≥</option>
                            </select>
                            <input type="number" class="form-control" id="limitRanking" name="limit_ranking" placeholder="Enter ranking limit" min="1">
                        </div>
                    </div>
                    <div class="alert alert-info small" role="alert">
                        <strong>Example:</strong> If you set bonus "5", condition "≤", and limit "3", the player will get 5 bonus points when the opponent's ranking is 3 or better (1, 2, or 3).
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Add Player</button>
            <button type="button" class="btn btn-link w-100 mt-2" id="backToChoiceFromNew">Back</button>

            <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
        </form>
        <!-- Step 2b: Import Player Form -->
        <form method="post" action="/trainer/player_import" id="importPlayerForm" style="display: none;">
            <div class="mb-3">
                <label for="importPlayerSelect" class="form-label">Select Existing Signup</label>
                <select class="form-select" id="importPlayerSelect" name="import_player_id" required>
                    <option value="">Choose player...</option>
                    {% for signup in allPlayers %}
                        {% if signup.id not in players|map(attribute='id')|list %}
                            <option value="{{ signup.id }}">{{ signup.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-success w-100">Import Player</button>
            <button type="button" class="btn btn-link w-100 mt-2" id="backToChoiceFromImport">Back</button>
            <input type="hidden" id="ranking-id" name="rankingId" value="{{ rankingId }}">
        </form>
    </div>
</div>

<!-- Active Matches Settings Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="activeMatchesSettings" aria-labelledby="activeMatchesSettingsLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="activeMatchesSettingsLabel">Display Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="mb-3">
            <label for="displayMode" class="form-label">Display Mode</label>
            <select class="form-select" id="displayMode">
                <option value="carousel">Carousel</option>
                <option value="grid">Grid View</option>
            </select>
        </div>
        
        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showElapsed">
                <label class="form-check-label" for="showElapsed">
                    Show elapsed time
                </label>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefresh">
                <label class="form-check-label" for="autoRefresh">
                    Auto-refresh (30s)
                </label>
            </div>
        </div>
        
        <button type="button" class="btn btn-primary w-100" id="applySettings">Apply Settings</button>
    </div>
</div>

{% endblock %}